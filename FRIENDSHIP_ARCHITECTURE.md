# Friendship System Architecture

## ğŸ—ï¸ System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USER INTERFACE LAYER                          â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      AddFriendsPage.tsx                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚   Search     â”‚  â”‚   Friend     â”‚  â”‚   Current    â”‚          â”‚  â”‚
â”‚  â”‚  â”‚   Users      â”‚  â”‚   Requests   â”‚  â”‚   Friends    â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Button States:                                                 â”‚  â”‚
â”‚  â”‚  â€¢ "Add" (none)         â€¢ "Requested" (outgoing)               â”‚  â”‚
â”‚  â”‚  â€¢ "Accept" (incoming)  â€¢ "Friends" (confirmed)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ useWebsite() hook
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       REACT CONTEXT LAYER                               â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    WebsiteContext.tsx                            â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  State:                      Functions:                         â”‚  â”‚
â”‚  â”‚  â€¢ friends[]                 â€¢ sendFriendRequest()              â”‚  â”‚
â”‚  â”‚  â€¢ incomingRequests[]        â€¢ acceptFriendRequest()            â”‚  â”‚
â”‚  â”‚  â€¢ outgoingRequests[]        â€¢ unfriendOrCancel()               â”‚  â”‚
â”‚  â”‚  â€¢ profile                   â€¢ searchUsers()                    â”‚  â”‚
â”‚  â”‚  â€¢ tasks                     â€¢ getFriendshipStatus()            â”‚  â”‚
â”‚  â”‚  â€¢ posts                     â€¢ refetchFriendships()             â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Lifecycle:                                                     â”‚  â”‚
â”‚  â”‚  1. User logs in                                                â”‚  â”‚
â”‚  â”‚  2. Fetch profile, tasks, posts, friendships (parallel)         â”‚  â”‚
â”‚  â”‚  3. Store in state                                              â”‚  â”‚
â”‚  â”‚  4. Auto-refetch after mutations                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Import & Call
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TYPESCRIPT HELPERS LAYER                           â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      friendships.ts                              â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Core Functions:                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ sendFriendRequest(currentUserId, targetUserId)          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Check if friendship exists                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Insert row with status='requested'                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Return { error, data }                                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ acceptFriendRequest(currentUserId, requesterId)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Find request where user is addressee                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Update status to 'confirmed'                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Return { error }                                      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ unfriendOrCancel(currentUserId, otherUserId)            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Delete friendship row (either direction)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Return { error }                                      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Query Functions:                                               â”‚  â”‚
â”‚  â”‚  â€¢ getFriends() - Get confirmed friendships with profiles       â”‚  â”‚
â”‚  â”‚  â€¢ getIncomingRequests() - Get requested where user=addressee   â”‚  â”‚
â”‚  â”‚  â€¢ getOutgoingRequests() - Get requested where user=requester   â”‚  â”‚
â”‚  â”‚  â€¢ searchUsers() - Search profiles by name/username/email       â”‚  â”‚
â”‚  â”‚  â€¢ getFriendshipBetweenUsers() - Check status (internal)        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Supabase Client
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SUPABASE CLIENT LAYER                           â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        supabase.ts                               â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  const supabase = createClient(url, anonKey)                    â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Operations:                                                    â”‚  â”‚
â”‚  â”‚  â€¢ supabase.from('friendships').select()                        â”‚  â”‚
â”‚  â”‚  â€¢ supabase.from('friendships').insert()                        â”‚  â”‚
â”‚  â”‚  â€¢ supabase.from('friendships').update()                        â”‚  â”‚
â”‚  â”‚  â€¢ supabase.from('friendships').delete()                        â”‚  â”‚
â”‚  â”‚  â€¢ supabase.from('profiles').select()                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ HTTP/REST API
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATABASE LAYER                                 â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    PostgreSQL Database                           â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚             Table: friendships                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Columns:                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ id (BIGSERIAL PRIMARY KEY)                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ requester_id (UUID FK â†’ auth.users.id)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ addressee_id (UUID FK â†’ auth.users.id)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ status (TEXT: 'requested' | 'confirmed')             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ created_at (TIMESTAMPTZ)                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ updated_at (TIMESTAMPTZ)                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Constraints:                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ UNIQUE (LEAST(requester, addressee),                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚            GREATEST(requester, addressee))              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ CHECK (requester_id != addressee_id)                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Indexes:                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ idx_friendships_requester                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ idx_friendships_addressee                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ idx_friendships_status                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ idx_friendships_users                                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚            Table: profiles                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Columns:                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ id (UUID PRIMARY KEY)                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ username (TEXT UNIQUE)                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ first_name, last_name (TEXT)                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ email (TEXT)                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ avatar_url (TEXT)                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ caption (TEXT)                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ created_at, updated_at (TIMESTAMPTZ)                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚           Row Level Security (RLS)                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Friendships Policies:                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ INSERT: auth.uid() = requester_id                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ SELECT: auth.uid() IN (requester_id, addressee_id)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ UPDATE: auth.uid() IN (requester_id, addressee_id)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ DELETE: auth.uid() IN (requester_id, addressee_id)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Profiles Policies:                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ SELECT: true (allow all - for friend search)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ UPDATE: auth.uid() = id                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ INSERT: auth.uid() = id                              â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Data Flow Examples

### Example 1: Sending a Friend Request

```
User A clicks "Add" on User B's profile
        â”‚
        â–¼
AddFriendsPage.tsx
  â†’ handleSendRequest(userB_id)
        â”‚
        â–¼
WebsiteContext
  â†’ sendFriendRequest(userB_id)
        â”‚
        â–¼
friendships.ts
  â†’ sendFriendRequest(userA_id, userB_id)
    1. Check if friendship exists
    2. Insert row: { requester: A, addressee: B, status: 'requested' }
        â”‚
        â–¼
Supabase Client
  â†’ supabase.from('friendships').insert(...)
        â”‚
        â–¼
PostgreSQL
  â†’ INSERT INTO friendships ...
  â†’ Check constraints (unique, different users)
  â†’ Check RLS policies (userA can insert as requester)
  â†’ Return success
        â”‚
        â–¼
friendships.ts
  â†’ Return { error: null, data: friendship }
        â”‚
        â–¼
WebsiteContext
  â†’ refetchFriendships()
    â†’ Update state: outgoingRequests.push(new request)
        â”‚
        â–¼
AddFriendsPage.tsx
  â†’ UI updates: "Add" â†’ "Requested" button
  â†’ User A sees yellow "Requested" button
```

### Example 2: Accepting a Friend Request

```
User B sees User A in "Friend Requests"
        â”‚
        â–¼
AddFriendsPage.tsx
  â†’ handleAcceptRequest(userA_id)
        â”‚
        â–¼
WebsiteContext
  â†’ acceptFriendRequest(userA_id)
        â”‚
        â–¼
friendships.ts
  â†’ acceptFriendRequest(userB_id, userA_id)
    1. Find friendship where requester=A, addressee=B
    2. Update status to 'confirmed'
        â”‚
        â–¼
Supabase Client
  â†’ supabase.from('friendships').update({ status: 'confirmed' })
        â”‚
        â–¼
PostgreSQL
  â†’ UPDATE friendships SET status='confirmed' WHERE ...
  â†’ Check RLS policies (userB can update as addressee)
  â†’ Return success
        â”‚
        â–¼
friendships.ts
  â†’ Return { error: null }
        â”‚
        â–¼
WebsiteContext
  â†’ refetchFriendships()
    â†’ Update state: 
      - Remove from incomingRequests
      - Add to friends
        â”‚
        â–¼
AddFriendsPage.tsx
  â†’ UI updates: "Accept" â†’ "Friends" button
  â†’ User B sees green "Friends" button
  â†’ User A also sees green "Friends" button (when they check)
```

### Example 3: Searching for Users

```
User types "john" in search box
        â”‚ (300ms debounce)
        â–¼
AddFriendsPage.tsx
  â†’ useEffect triggers after debounce
  â†’ searchUsers("john")
        â”‚
        â–¼
WebsiteContext
  â†’ searchUsers("john")
        â”‚
        â–¼
friendships.ts
  â†’ searchUsers("john", currentUserId, limit=20)
    â†’ Query: profiles WHERE username/name/email ILIKE '%john%'
        â”‚
        â–¼
Supabase Client
  â†’ supabase.from('profiles').select()
        â”‚
        â–¼
PostgreSQL
  â†’ SELECT * FROM profiles 
    WHERE (username ILIKE '%john%' OR first_name ILIKE '%john%' ...)
    AND id != currentUserId
    LIMIT 20
  â†’ Check RLS policies (SELECT: true - allow all)
  â†’ Return matching profiles
        â”‚
        â–¼
friendships.ts
  â†’ Return { error: null, data: [profiles] }
        â”‚
        â–¼
WebsiteContext
  â†’ Return profiles to component
        â”‚
        â–¼
AddFriendsPage.tsx
  â†’ setSearchResults(profiles)
  â†’ For each profile, getFriendshipStatus(profile.id)
  â†’ Render user cards with appropriate button states
```

## ğŸ” Security Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Request                        â”‚
â”‚  supabase.from('friendships').insert(...)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Supabase Edge Functions   â”‚
        â”‚   (JWT Token Validation)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Row Level Security (RLS)  â”‚
        â”‚   Check Policies            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
   âœ… ALLOWED               âŒ DENIED
   Execute Query           Return Error
        â”‚                         â”‚
        â–¼                         â–¼
   Return Success          HTTP 403
```

### RLS Policy Examples

**INSERT Policy**: Users can only create requests they send
```sql
WITH CHECK (auth.uid() = requester_id)

Example:
- User A tries to insert { requester: A, addressee: B } âœ… ALLOWED
- User A tries to insert { requester: B, addressee: C } âŒ DENIED
```

**SELECT Policy**: Users can only view friendships they're part of
```sql
USING (auth.uid() = requester_id OR auth.uid() = addressee_id)

Example:
- User A views friendship { requester: A, addressee: B } âœ… ALLOWED
- User B views friendship { requester: A, addressee: B } âœ… ALLOWED
- User C views friendship { requester: A, addressee: B } âŒ DENIED
```

## ğŸ“Š State Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WebsiteContext State                    â”‚
â”‚                                                          â”‚
â”‚  Initial State (user logged out):                       â”‚
â”‚  {                                                       â”‚
â”‚    friends: [],                                          â”‚
â”‚    incomingRequests: [],                                 â”‚
â”‚    outgoingRequests: [],                                 â”‚
â”‚    profile: null,                                        â”‚
â”‚    loading: true                                         â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          User Logs In
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Parallel Data Fetching                      â”‚
â”‚                                                          â”‚
â”‚  Promise.all([                                           â”‚
â”‚    fetchProfile(userId),         â”€â”€â”€â”€â”€â”                 â”‚
â”‚    fetchTasks(userId),            â”‚   â”‚                 â”‚
â”‚    fetchPosts(userId),            â”‚   â”‚ All happen      â”‚
â”‚    fetchFriendships(userId)       â”‚   â”‚ simultaneously  â”‚
â”‚  ])                               â”‚   â”‚                 â”‚
â”‚                                   â–¼   â–¼                 â”‚
â”‚  fetchFriendships() calls:                              â”‚
â”‚    â€¢ getFriends()                                       â”‚
â”‚    â€¢ getIncomingRequests()                              â”‚
â”‚    â€¢ getOutgoingRequests()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              State Updated (loaded)                      â”‚
â”‚                                                          â”‚
â”‚  {                                                       â”‚
â”‚    friends: [                                            â”‚
â”‚      { id: 1, profile: {...}, status: 'confirmed' }     â”‚
â”‚    ],                                                    â”‚
â”‚    incomingRequests: [                                   â”‚
â”‚      { id: 2, profile: {...}, status: 'requested' }     â”‚
â”‚    ],                                                    â”‚
â”‚    outgoingRequests: [                                   â”‚
â”‚      { id: 3, profile: {...}, status: 'requested' }     â”‚
â”‚    ],                                                    â”‚
â”‚    profile: {...},                                       â”‚
â”‚    loading: false                                        â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
      User takes action (e.g., send request)
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Action & Refetch                            â”‚
â”‚                                                          â”‚
â”‚  1. sendFriendRequest(userId)                            â”‚
â”‚  2. Database updated                                     â”‚
â”‚  3. refetchFriendships()                                 â”‚
â”‚  4. State updated with new data                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Component Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     App.tsx                              â”‚
â”‚  <WebsiteProvider>                                       â”‚
â”‚    <Router>                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚
         â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HomePage       â”‚     â”‚  SocialPage     â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚  const {        â”‚     â”‚  const {        â”‚
â”‚    friends      â”‚     â”‚    friends,     â”‚
â”‚  } = useWebsite()â”‚    â”‚    profile      â”‚
â”‚                 â”‚     â”‚  } = useWebsite()â”‚
â”‚  Show count     â”‚     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                  Navigate to    â”‚
                  Add Friends    â”‚
                                 â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  AddFriendsPage     â”‚
                     â”‚                     â”‚
                     â”‚  const {            â”‚
                     â”‚    friends,         â”‚
                     â”‚    incomingRequests,â”‚
                     â”‚    outgoingRequests,â”‚
                     â”‚    searchUsers,     â”‚
                     â”‚    sendFriendRequestâ”‚
                     â”‚    acceptFriendReq, â”‚
                     â”‚    unfriendOrCancel,â”‚
                     â”‚    getFriendshipSta â”‚
                     â”‚  } = useWebsite()   â”‚
                     â”‚                     â”‚
                     â”‚  Render sections:   â”‚
                     â”‚  â€¢ Friend Requests  â”‚
                     â”‚  â€¢ Search Results   â”‚
                     â”‚  â€¢ Current Friends  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This architecture ensures:
- âœ… **Separation of Concerns**: Each layer has a clear responsibility
- âœ… **Security**: RLS enforced at database level
- âœ… **Performance**: Parallel fetching, indexed queries
- âœ… **Maintainability**: Simple, well-documented code
- âœ… **Scalability**: Can handle thousands of friendships
- âœ… **Type Safety**: Full TypeScript coverage
